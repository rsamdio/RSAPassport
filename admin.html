<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Admin - RSA Passport</title>
    <link rel="icon" type="image/svg+xml" href="favicon.png"/>
    <link rel="apple-touch-icon" href="favicon.png"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "background-light": "#f5f8f8",
                        "background-dark": "#101e22",
                        "surface-dark": "#1a2c32",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "2xl": "2rem",
                        "full": "9999px"
                    }
                },
            },
        }
    </script>
    <link rel="stylesheet" href="style.css">
    <style>
        @media (min-width: 768px) {
            .admin-container {
                max-width: 1200px;
            }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 2px solid #0db9f2;
            color: #0db9f2;
        }
    </style>
</head>
<body class="bg-background-dark min-h-screen font-display text-white">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-background-dark flex items-center justify-center z-50">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
            <p class="text-slate-300">Checking authentication...</p>
        </div>
    </div>
    
    <div id="main-content" class="admin-container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-3xl font-bold">Admin Panel</h1>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    Logout
                </button>
            </div>
            <p class="text-slate-400">Manage participants, ranks, and view leaderboard</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-white/10">
            <div class="flex gap-4">
                <button id="tab-add" class="tab-button px-4 py-3 font-semibold text-slate-300 hover:text-white active">
                    Add Participants
                </button>
                <button id="tab-manage" class="tab-button px-4 py-3 font-semibold text-slate-300 hover:text-white">
                    Manage Participants
                </button>
                <button id="tab-ranks" class="tab-button px-4 py-3 font-semibold text-slate-300 hover:text-white">
                    Manage Ranks
                </button>
                <button id="tab-leaderboard" class="tab-button px-4 py-3 font-semibold text-slate-300 hover:text-white">
                    Leaderboard
                </button>
            </div>
        </div>

        <!-- Tab 1: Add Participants -->
        <div id="tab-content-add" class="tab-content active">
            <!-- Individual Participant Form -->
            <div class="bg-[#1a2c32] rounded-2xl p-6 mb-8 border border-white/10">
                <h2 class="text-xl font-bold mb-4">Add New Participant</h2>
                <form id="add-participant-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Participant ID *</label>
                        <input type="text" id="participant-id" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary"
                            placeholder="e.g., P001">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Full Name *</label>
                        <input type="text" id="participant-fullname" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">District *</label>
                        <input type="text" id="participant-district" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Email *</label>
                        <input type="email" id="participant-email" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary"
                            placeholder="Email address (used for Google login)">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Phone *</label>
                        <input type="tel" id="participant-phone" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary"
                            placeholder="+1234567890">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Profession *</label>
                        <input type="text" id="participant-profession" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="add-participant-btn"
                            class="w-full md:w-auto px-6 py-3 bg-primary hover:bg-[#0aa6da] rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            <span id="btn-text">Loading QR Code Library...</span>
                        </button>
                        <p id="library-status" class="text-xs text-slate-400 mt-2">⏳ Initializing QR Code library...</p>
                    </div>
                </form>
            </div>

            <!-- CSV Bulk Upload -->
            <div class="bg-[#1a2c32] rounded-2xl p-6 mb-8 border border-white/10">
                <h2 class="text-xl font-bold mb-4">Bulk Upload via CSV</h2>
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <button id="download-template-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                            Download CSV Template
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Upload CSV File</label>
                        <input type="file" id="csv-file-input" accept=".csv" 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                        <p class="text-xs text-slate-400 mt-1">Select a CSV file with participant data</p>
                    </div>
                    <button id="upload-csv-btn" class="px-6 py-3 bg-primary hover:bg-[#0aa6da] rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Upload and Import
                    </button>
                    <div id="csv-upload-progress" class="hidden">
                        <div class="bg-background-dark rounded-lg p-4">
                            <p class="text-sm text-slate-300 mb-2">Importing participants...</p>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div id="csv-progress-bar" class="bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <p id="csv-progress-text" class="text-xs text-slate-400 mt-2">0 of 0</p>
                        </div>
                    </div>
                    <div id="csv-upload-results" class="hidden">
                        <div class="bg-background-dark rounded-lg p-4">
                            <p id="csv-results-text" class="text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tab 3: Manage Ranks -->
        <div id="tab-content-ranks" class="tab-content">
            <div class="bg-[#1a2c32] rounded-2xl p-6 border border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Rank Management</h2>
                    <button id="add-rank-btn" class="px-4 py-2 bg-primary hover:bg-[#0aa6da] rounded-lg transition-colors">
                        Add Rank
                    </button>
                </div>
                <p class="text-sm text-slate-400 mb-4">Configure rank levels and their score requirements. Ranks are ordered by their order value (lower numbers appear first).</p>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Order</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Rank Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Min Score</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Max Score</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ranks-list">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-slate-400">Loading ranks...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Manage Participants -->
        <div id="tab-content-manage" class="tab-content">
            <div class="bg-[#1a2c32] rounded-2xl p-6 border border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Participants</h2>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-400">
                            Total: <span id="participant-count">0</span>
                        </div>
                        <button id="export-participants-btn" class="px-4 py-2 bg-primary hover:bg-[#0aa6da] rounded-lg transition-colors text-sm font-semibold">
                            Export All
                        </button>
                    </div>
                </div>
                
                <!-- Search/Filter -->
                <div class="mb-4">
                    <input type="text" id="search-participants" placeholder="Search participants..."
                        class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                </div>

                <!-- Participants Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Participant ID</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Email</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Status</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Rank & Score</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">Loading participants...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 3: Leaderboard -->
        <div id="tab-content-leaderboard" class="tab-content">
            <div class="bg-[#1a2c32] rounded-2xl p-6 border border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Leaderboard</h2>
                    <div class="flex gap-2">
                    <button id="refresh-leaderboard-btn" class="px-4 py-2 bg-primary hover:bg-[#0aa6da] rounded-lg transition-colors">
                        Refresh
                    </button>
                        <button id="sync-firestore-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm mr-2">
                            Sync Firestore to RTDB
                        </button>
                        <button id="refresh-all-caches-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm">
                            Refresh All Caches
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Rank</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Full Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">District</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Email</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Score</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Level</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-list">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">Loading leaderboard...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Prompt (shown if not authenticated) -->
    <div id="login-prompt" class="hidden fixed inset-0 bg-background-dark flex items-center justify-center z-50">
        <div class="bg-[#1a2c32] rounded-2xl p-8 max-w-md w-full mx-4 border border-white/10">
            <h2 class="text-2xl font-bold mb-4 text-center">Admin Access Required</h2>
            <p class="text-slate-300 mb-6 text-center">Please sign in with your Google account to access the admin panel.</p>
            <button id="admin-signin-btn" class="w-full px-6 py-3 bg-primary hover:bg-[#0aa6da] rounded-lg font-bold transition-colors flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
            <p class="text-xs text-slate-400 mt-4 text-center">Or <a href="index.html" class="text-primary hover:underline">go to main app</a></p>
        </div>
    </div>

    <!-- Rank Modal (for Add/Edit) -->
    <div id="rank-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-[#1a2c32] rounded-2xl p-6 max-w-md w-full mx-4 border border-white/10">
            <h3 id="rank-modal-title" class="text-xl font-bold mb-4">Add Rank</h3>
            <form id="rank-form">
                <input type="hidden" id="rank-index">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Rank Name *</label>
                        <input type="text" id="rank-name" required 
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Min Score *</label>
                        <input type="number" id="rank-min-score" required min="0"
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Max Score</label>
                        <input type="number" id="rank-max-score" min="0"
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary"
                            placeholder="Leave empty for highest rank">
                        <p class="text-xs text-slate-400 mt-1">Leave empty for the highest rank</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-slate-300">Order *</label>
                        <input type="number" id="rank-order" required min="0"
                            class="w-full px-4 py-2 bg-background-dark border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                        <p class="text-xs text-slate-400 mt-1">Lower numbers appear first</p>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-[#0aa6da] rounded-lg transition-colors">
                        Save
                    </button>
                    <button type="button" id="rank-modal-cancel" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div id="alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="alert-modal-content" class="bg-[#1a2c32]/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 p-6 max-w-md w-full transform transition-all duration-200 scale-95 opacity-0">
            <div class="flex flex-col items-center gap-4">
                <!-- Icon (dynamically set) -->
                <div id="alert-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center border-2">
                    <span id="alert-icon" class="material-symbols-outlined text-4xl"></span>
                </div>
                
                <!-- Title and Message -->
                <div class="text-center space-y-2 w-full">
                    <h3 id="alert-title" class="text-xl font-bold text-white"></h3>
                    <p id="alert-message" class="text-white/70 text-sm leading-relaxed whitespace-pre-line"></p>
                </div>
                
                <!-- Button -->
                <button id="alert-ok-btn" class="w-full px-4 py-3 rounded-xl font-semibold transition-colors active:scale-95 mt-2">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="confirm-modal-content" class="bg-[#1a2c32]/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 p-6 max-w-md w-full transform transition-all duration-200 scale-95 opacity-0">
            <div class="flex flex-col items-center gap-4">
                <!-- Icon -->
                <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center border-2 border-yellow-500/30">
                    <span class="material-symbols-outlined text-yellow-400 text-4xl">help</span>
                </div>
                
                <!-- Title and Message -->
                <div class="text-center space-y-2 w-full">
                    <h3 id="confirm-title" class="text-xl font-bold text-white">Confirm Action</h3>
                    <p id="confirm-message" class="text-white/70 text-sm leading-relaxed"></p>
                </div>
                
                <!-- Buttons -->
                <div class="flex gap-3 w-full mt-2">
                    <button id="confirm-cancel-btn" class="flex-1 px-4 py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold transition-colors active:scale-95">
                        Cancel
                    </button>
                    <button id="confirm-ok-btn" class="flex-1 px-4 py-3 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 font-semibold border border-yellow-500/30 transition-colors active:scale-95">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        window.firebaseModules = { initializeApp, getAuth, getFirestore };
    </script>
    
    <!-- QR Code Library - Using qrcode-generator (more reliable) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
        // Ensure qrcode is available globally when loaded
        (function() {
            function initQRCode() {
                if (typeof qrcode !== 'undefined') {
                    window.qrcodeGenerator = qrcode;
                    window.QRCodeLibraryReady = true;
                    console.log('✓ QRCode generator library loaded successfully');
                    
                    // Update UI
                    const btn = document.getElementById('add-participant-btn');
                    const btnText = document.getElementById('btn-text');
                    const statusText = document.getElementById('library-status');
                    
                    if (btn) {
                        btn.disabled = false;
                        if (btnText) btnText.textContent = 'Add Participant';
                    }
                    if (statusText) {
                        statusText.textContent = '✓ QR Code library ready';
                        statusText.className = 'text-xs text-green-400 mt-2';
                    }
                } else {
                    setTimeout(initQRCode, 50);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initQRCode);
            } else {
                initQRCode();
            }
        })();
    </script>
    
    <!-- Admin Script -->
    <script type="module" src="admin.js"></script>
</body>
</html>
