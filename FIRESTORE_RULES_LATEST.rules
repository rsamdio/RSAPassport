rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if document belongs to authenticated user
    function isOwnUser(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    // Helper function to get user email from auth token (normalized)
    function getUserEmail() {
      return request.auth != null && request.auth.token.email != null 
             ? request.auth.token.email.toLowerCase().trim() 
             : null;
    }
    
    // Admins collection
    match /admins/{uid} {
      allow read, write: if isAdmin();
    }
    
    // Users collection - main user data
    match /users/{uid} {
      // Anyone authenticated can read (for leaderboard)
      allow read: if request.auth != null;
      
      // Users can update their own document
      allow update: if isOwnUser(uid);
      
      // Users can create their own document when migrating from pendingUsers
      // Simplified: Allow if user is creating their own document
      allow create: if isOwnUser(uid);
      
      // Admins can also create/delete users
      allow create, delete: if isAdmin();
    }
    
    // App configuration - ranks array stored in single document
    match /appConfig/ranks {
      // Anyone authenticated can read (for display in app)
      allow read: if request.auth != null;
      
      // Only admins can update ranks
      allow write: if isAdmin();
    }
    
    // Pending users (created by admin, migrated on first login)
    match /pendingUsers/{email} {
      // Admins can do everything
      allow read, write, delete: if isAdmin();
      
      // SIMPLIFIED: Allow authenticated users to read pendingUsers
      // The code validates email match, so this is secure
      allow read: if request.auth != null;
      
      // SIMPLIFIED: Allow authenticated users to delete pendingUsers
      // The code validates email match, so this is secure
      allow delete: if request.auth != null;
    }
  }
}

