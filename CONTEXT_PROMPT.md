# RSA Passport - Complete Application Context

## Application Overview

**RSA Passport** is a gamified networking application for the Rotasia 2026 Chennai event. It allows participants to connect with each other by scanning QR codes, earn points, and compete on a leaderboard. The application uses a hybrid Firebase architecture (Realtime Database + Firestore) for cost optimization.

**Application Name:** RSA Passport  
**Event:** Rotasia 2026 Chennai  
**Tagline:** "Connect. Network. Grow."

## Tech Stack

- **Frontend:** Vanilla HTML, CSS, JavaScript (ES6+ modules) - No frameworks
- **Styling:** Tailwind CSS (via CDN) with custom configuration
- **Icons:** Material Symbols Outlined (Google Fonts)
- **Font:** Plus Jakarta Sans
- **Backend:** Firebase
  - **Authentication:** Firebase Auth (Google Sign-In)
  - **Database:** Hybrid Architecture
    - **Firestore:** User data, scores, scan history, ranks configuration
    - **Realtime Database (RTDB):** QR code lookup layer for fast, cost-effective scanning
- **QR Code Libraries:**
  - **Generation:** `qrcode-generator` (admin panel)
  - **Scanning:** `html5-qrcode` (participant app)

## File Structure

```
/
├── index.html          # Main participant application (all views in single file)
├── app.js             # Participant app logic (Firebase, scanning, scoring)
├── style.css          # Custom CSS (glassmorphism, animations, scanner fixes)
├── admin.html         # Admin panel (desktop-optimized, responsive)
├── admin.js           # Admin panel logic (participant management, ranks, CSV import)
├── favicon.png        # Application favicon
├── FIRESTORE_RULES_FINAL.md  # Firestore security rules
├── ADMIN_SETUP.md     # Admin setup documentation
└── seed-data.js       # Node.js script for batch user seeding
```

## Core Features

### Participant Application (`index.html` + `app.js`)

1. **Authentication**
   - Google Sign-In via Firebase Auth
   - Only participants added by admin can log in
   - Single-device login enforcement (session tokens)
   - Custom access denied modal (replaces browser alerts)

2. **User Profile (Passport View)**
   - Displays: Full Name, District (RI District {number}), Profile Picture, Score, Rank
   - QR Code display (pre-generated by admin, stored as base64 in Firestore)
   - Recent connections preview
   - Logout button

3. **QR Code Scanner**
   - Camera-based scanning using `html5-qrcode`
   - Prevents self-scanning
   - Prevents duplicate scans (atomic transaction check)
   - Awards 10 points per valid scan
   - Subtle toast notifications (success/error) - no bulky alerts
   - Debouncing to prevent multiple scans
   - Auto-stops when view changes or page hidden
   - Single video element (no mirroring/duplicates)

4. **Leaderboard**
   - Top 10 users by score (descending)
   - Composite index: `score (descending), firstLoginAt (ascending)`
   - Shows: Rank, Name, District, Email, Score, Level
   - Top 3 highlighted with special styling

5. **Connection History**
   - Lists all scanned connections from `scanHistory` array
   - Shows: Name, Photo, Date, District
   - "Save to Contacts" button (vCard/Web Share API)
   - Saves: Name, Email, Phone to device contacts

6. **Navigation**
   - Sticky footer with: Home, Scan (prominent), Leaderboard icons
   - Header history icon in passport view
   - Smooth view transitions

7. **Dynamic Rank System**
   - Ranks fetched from `appConfig/ranks` document (array)
   - Cached for 5 minutes
   - Fallback to default ranks if fetch fails
   - Rank calculated based on score ranges

### Admin Panel (`admin.html` + `admin.js`)

1. **Authentication**
   - Admin-only access (checked via `admins` collection)
   - Google Sign-In required
   - Loading screen during auth check

2. **Tabbed Interface**
   - **Add Participants:** Individual form + CSV bulk upload
   - **Manage Participants:** View, search, edit, delete, export
   - **Manage Ranks:** CRUD operations for rank configuration
   - **Leaderboard:** View top participants

3. **Participant Management**
   - **Fields:** ParticipantID, FullName, District, Email, Phone, Profession
   - **QR Code:** Pre-generated 32-char random hex token
   - **Storage:** `pendingUsers/{email}` → migrates to `users/{uid}` on first login
   - **CSV Import:** Template download, validation, duplicate checking, progress tracking
   - **Export:** Download all participants as CSV

4. **Rank Management**
   - **Structure:** Single document `appConfig/ranks` with array of rank objects
   - **Fields:** rankName, minScore, maxScore (null for highest), order
   - **Validation:** No gaps/overlaps in score ranges
   - **Ordering:** Ranks sorted by `order` field (lower numbers first)

5. **Custom Modals**
   - **Alert Modal:** Success (green), Error (red), Warning (yellow), Info (blue)
   - **Confirmation Modal:** For delete/import actions
   - **No browser alerts/confirms** - all replaced with custom UI

## Database Architecture

### Hybrid Architecture (Cost Optimization)

**Realtime Database (RTDB) - The Lookup Layer**
- **Path:** `qrcodes/{qrToken}`
- **Schema:** `{ "uid": "user_123", "name": "Jane", "photo": "url" }`
- **Purpose:** Fast QR code lookup without Firestore read costs
- **Region:** `asia-southeast1` (Asia-Southeast1)

**Firestore - The State Layer**

1. **Collection: `users/{uid}`**
   - **Fields:**
     - `displayName`, `fullName`, `photoURL`, `email`
     - `participantId`, `district`, `phone`, `profession`
     - `score` (number), `rank` (string)
     - `scanHistory` (array of objects with: uid, name, photo, email, phone, district, profession, scannedAt)
     - `qrToken` (32-char hex), `qrCodeBase64` (pre-generated)
     - `firstLoginAt`, `lastLoginAt` (timestamps)
     - `sessionToken` (for single-device login)
   - **Purpose:** Main user data, scoring, connection history

2. **Collection: `pendingUsers/{email}`**
   - **Fields:** Same as users, but email as document ID
   - **Purpose:** Admin-added participants before first login
   - **Migration:** Automatically migrates to `users/{uid}` on first login

3. **Collection: `admins/{uid}`**
   - **Purpose:** Admin access control
   - **Fields:** Minimal (just exists check)

4. **Document: `appConfig/ranks`**
   - **Structure:** `{ ranks: [array of rank objects] }`
   - **Rank Object:** `{ rankName, minScore, maxScore, order }`
   - **Purpose:** Dynamic rank configuration

### Removed Collections
- `connections` collection (removed - duplicate prevention now in `scanHistory` array)
- `participants` collection (merged into `users`)

## Security Rules

### Firestore Rules

**Key Helpers:**
- `isAdmin()` - Checks `admins/{uid}` exists
- `isOwnUser(uid)` - Checks `request.auth.uid == uid`
- `getUserEmail()` - Returns normalized user email
- `normalizeEmail(email)` - Case-insensitive, trimmed email

**Rules Summary:**
- `admins`: Read/write only by admins
- `users`: 
  - Read: All authenticated users (for leaderboard)
  - Create: Admins OR during migration from `pendingUsers`
  - Update: Own user (with field restrictions) OR admins
  - Delete: Admins only
- `pendingUsers`: 
  - Read/Delete: Admins OR own email match
  - Write: Admins only
- `appConfig/ranks`: 
  - Read: All authenticated users
  - Write: Admins only

### RTDB Rules

- **Read:** Authenticated users can read specific `qrcodes/{token}` nodes
- **Write:** Authenticated users can write their own QR code data (`uid` must match `auth.uid`)
- **No listing:** Prevents enumeration of all QR codes

## UI/UX Design

### Color Scheme
- **Primary:** `#0db9f2` (cyan blue)
- **Background Dark:** `#101e22`
- **Surface Dark:** `#1a2c32`
- **Background Light:** `#f5f8f8`

### Design Principles
- **Mobile-first:** Responsive design, optimized for mobile
- **Dark theme:** Primary theme with light mode support
- **Glassmorphism:** Backdrop blur effects, semi-transparent panels
- **Smooth animations:** 200ms transitions, scale/opacity effects
- **No browser alerts:** All replaced with custom modals/toasts

### Key UI Components

1. **Toast Notifications**
   - Subtle slide-in/out animations
   - Top-center positioning
   - Auto-dismiss
   - Icons: check_circle (success), error (error)

2. **Modals**
   - Backdrop blur
   - Scale + opacity animations
   - ESC key to close
   - Click outside to close

3. **Sticky Footer Navigation**
   - Fixed bottom position
   - Home, Scan (larger), Leaderboard icons
   - Present on all main views

4. **Scanner View**
   - Full-screen camera view
   - Gradient overlays
   - Centered QR reader box
   - Instructions text

## Key Implementation Details

### QR Code Generation
- **Admin Panel:** Pre-generates QR codes as base64 strings
- **Token:** Random 32-character hex string (cryptographically secure)
- **Storage:** Saved in `pendingUsers` and `users` documents
- **Display:** Direct base64 image display (no client-side generation)

### Scanning Logic (`processScan`)
1. Lookup target user from RTDB `qrcodes/{qrToken}`
2. Validate: Not self, QR exists
3. Fetch full user data from Firestore
4. **Atomic Transaction:**
   - Check `scanHistory` for duplicates (by uid, email, phone)
   - Increment score by 10
   - Add to `scanHistory` array (atomic)
   - Update rank
5. Show success toast
6. Reload profile

### Single Device Login
- **Mechanism:** Firestore `sessionToken` + `localStorage`
- **Flow:**
   - On login: Generate new token, store in Firestore and localStorage
   - On auth state change: Verify token matches
   - If mismatch: Logout and show error
- **Purpose:** Prevent concurrent logins on multiple devices

### Rank Calculation
- **Function:** `calculateRank(score)`
- **Process:**
   - Fetch ranks from `appConfig/ranks` (cached 5 min)
   - Find rank where `minScore <= score < maxScore` (or `maxScore === null`)
   - Fallback to default ranks if fetch fails
- **Default Ranks:**
   - 0-50: "Rookie"
   - 51-200: "Connector"
   - 200+: "Super Star"

### Scanner Management
- **State Flags:**
  - `scannerActive`: Boolean
  - `isProcessingScan`: Boolean (prevents concurrent scans)
  - `lastScannedToken`: String (debouncing)
  - `lastScanTime`: Number (debouncing)
- **Lifecycle:**
  - Auto-start when scanner view shown
  - Auto-stop when view changes
  - Stop on page visibility change
  - Stop on page unload
- **Configuration:**
  - `disableFlip: true` (no mirroring)
  - `aspectRatio: 1.0`
  - `fps: 10`

## Recent Improvements

1. **Custom Modals:** Replaced all `alert()` and `confirm()` with custom UI
2. **Toast Notifications:** Subtle, non-intrusive scan feedback
3. **Scanner UX:** Debouncing, processing flags, smooth operation
4. **Single Device Login:** Session token enforcement
5. **Contact Saving:** vCard export via Web Share API
6. **UI Polish:** Center-aligned headlines, improved spacing, better contrast
7. **Branding:** Renamed to "RSA Passport" throughout

## Firebase Configuration

**Placeholder Location:** Top of `app.js` and `admin.js`

```javascript
const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "...",
    databaseURL: "https://eventpasstest-default-rtdb.asia-southeast1.firebasedatabase.app"
};
```

## Important Notes

1. **No Email as Document ID:** Uses `uid` for `users` collection (best practice)
2. **Atomic Operations:** All critical updates use Firestore transactions
3. **Cost Optimization:** High-frequency QR lookups use RTDB (bandwidth-based billing)
4. **Error Handling:** Comprehensive try-catch blocks, user-friendly error messages
5. **Access Control:** Admin-only features protected by Firestore rules
6. **Data Migration:** Automatic migration from `pendingUsers` to `users` on first login
7. **QR Code Security:** Random 32-char tokens (unpredictable, secure)

## Dependencies (CDN)

- Firebase SDK v10.7.1 (modular imports)
- Tailwind CSS (CDN with plugins: forms, container-queries)
- Material Symbols Outlined (Google Fonts)
- Plus Jakarta Sans (Google Fonts)
- qrcode-generator v1.4.4
- html5-qrcode (latest)

## Browser Compatibility

- Modern browsers with ES6+ support
- Camera API support for scanning
- Web Share API for contact saving (with fallback)

---

**This prompt contains all context needed to understand, maintain, and extend the RSA Passport application.**

